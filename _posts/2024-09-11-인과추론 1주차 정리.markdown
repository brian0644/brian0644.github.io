---
layout: post
title:  "인과추론 1주차 정리"
date:   2024-09-11 11:58+09:00
categories: khuda causal inference study
---

# 1-1. 인과추론이란?

* 연관관계 : 두 개의 수치나 확률변수가 같이(양,음) 움직이는 것 
* 인과관계 : 한 변수의 변화가 다른 변수의 변화를 일으키는 것
* 회귀의 의미에서 둘의 경계가 상당히 모호하기 때문에 쉽게 착각을 일으킴(수식을 봤을때 y=ax+u 라면 연관관계와 인과관계의 정의 모두 부합하는 것처럼 느껴진다...)
* 그치만 우리는 개념적인 해석 관점에서 둘이 명확히 다르다는 것을 암

 
> **비록 연관관계는 인과관계가 아니지만 때로는 연관관계가 인과관계가 될 수도 있다는것  -> how?를 추론하는 것이 인과추론**
> **인과추론은 연관관계로부터 인과관계를 추론하고 언제, 그리고 왜 서로 다른지 이해하는 과학**


  

# 1-2. 인과추론 용어정리 


## 용어 정리
* T(처치) : 구하려는 효과에 대한 개입을 나타낼 때 사용하는 용어
* Y(결과) : 종속변수 Y, 주어진 효과에 따라 변화 양상을 지켜봐야하는 값
* T <- f(u) (외생변수) : 어떠한 다른 변수에도 영향을 **받지않는** 값, 관측(정의)되지 않은 다른 변수에 영향을 받지 않는 요인들 -> 처치를 정의할때는 외생변수 표기
* Y <- f(_...,u) )(내생변수) : 관측되지 않은 요인에 의해 영향을 받는 값 -> 결과를 정의할때는 내생변수 표기
* do(.) (개입) : 어떤 처치 T에서 동시에 일어날 수 없는 인과 추정량을 정의하는데 사용

  
  <img width="289" alt="스크린샷 2024-09-11 오후 12 37 45" src="https://github.com/user-attachments/assets/4644d254-ccf3-4bab-812c-f44f70300477">

  
* 식별 : 인과추정량에 대한 이론적 표현을 do(.)를 통하여 제거(구할 수 없지만 이론적으로 정의함으로써)하는 과정
* 개별 처치효과 (ITE) :
  <img width="159" alt="스크린샷 2024-09-11 오후 12 36 29" src="https://github.com/user-attachments/assets/38f2c4f5-4dcd-4cdd-ad4b-e38b878f5a08">
  
-> 같은 대상(i)의 결과를 동시에 측정한다는 가정 하에 두 처치에 대한 결과 차이값

* 잠재적 결과 : 두 개 이상의 처치에 관해 이야기할 때 나올 수 있는 모든 결과 경우의 수, 관측할 수 있는 것을 사실적 결과, 없는 것을 반사실적 결과
* 일치성 : 지정된 처치 T 외에 숨겨진 여러 가지 형태의 처치는 존재하지 않아야한다는 개념
* SUTVA : 상호 간섭 없음. 하나의 실험 대상에 대한 효과는 다른 실험 대상의 영향을 받지 않는다 (만약 파급효과나 네트워크 효과가 있는 경우, 위배)
* 인과추정량 : 반사실적 결과를 추정한 값
  * 평균 처치효과 (ATE) : 처치 T가 평균적으로 미치는 영향
  * 실험군에 대한 평균 처치효과 (ATT) : 처치 받은 대상에 대한 처치효과
  * 조건부 평균 처치효과 (CATE) : 변수 X로 정의된 그룹에서의 처치효과 
* 편향 : 인과관계와 연관관계를 다르게 만드는 요소, 인과 추정량은 말 그대로 추정량이기 때문에 일치하지 않음
  
  <img width="166" alt="스크린샷 2024-09-11 오후 12 51 05" src="https://github.com/user-attachments/assets/8e17bce8-df08-4916-a918-8d62fc745d43">
  
-> 해당 값이 0이라면 연관관계 = 인과관계,  **편향을 줄이기 위해서는 실험군과 대조군은 교환 가능해야한다(독립성 가정)** -> 랜덤적으로 처치를 배정하는 방법으로 해결



# 2-1. 무작위 실험 

무작위 실험은 결국 독립성(처치를 받았다고 해서 안받았을 때의 결과에 영향을 미치지 않는 것)을 만족시키기 위한 이상적인 방법

## A/B 테스트 사례

기업에서 신규 고객을 확보할 목적으로 마케팅 메일을 보내고자 한다. 이때 우리는 이러한 마케팅 이메일이 얼마나 효과적인지 알아내야하는 상황

1. 첫번째 상황
 일단 우리는 기본적으로 마케팅 메일을 보냈을때(T)와 안보냈을때의 전환율을 비교하고자 랜덤화하지 않은 기존 데이터를 살펴봄. **이메일을 보냈을때 전환율이 더 높았음**. 그러나 문제는 이 데이터를 수집할 때 마케팅 팀은 전환 가능성이 높다고 생각한 고객에게만 이메일을 보냈다 보니 당연히 이러한 결과 발생
실패 사유 : 랜덤 실험 (RTE)의 부재로 인한 편향 발생 -> 마케팅 이메일이 전환율과 인과관계라고 보기 어려움

2. 두번째 상황
 그렇기 때문에 우리는 이메일을 무작위로 고객에게 보내기로 했음. 그리고 여기서 메일을 보내지 않은 경우, 자세히 설명하는 긴 메일을 보낸 경우, 핵심을 담은 짧은 메일을 보낸 경우로 나뉨.

```python
import pandas as pd
import numpy as np

data = pd.read_csv("파일경로")

# data에서 cross_sell_email 이라는 칼럼들 기준으로 groupby하고 평균 구하기
data.groupby(["cross_sell_email"]).mean()
```

<img width="369" alt="스크린샷 2024-09-11 오후 1 07 54" src="https://github.com/user-attachments/assets/9eb1f48e-982a-4aea-b1ae-b598da80003c">

결과 해석 : 메일을 받지 않는 그룹 전환율 4.2%, 긴 메일과 짧은 메일을 받은 그룹은 각각 5.5%, 12.5% 전환율을 보임 -> 짧은 메일이 더 효과적
보완 사항 : 실험군과 대조군이 처치 받기 전에 동일했는지 확인해보기 -> 무작위로 고객을 선정했다면 그들의 성별, 나이도 1:1로 수렴해야하기 때문에 그 특성들의 비율을 살펴보면 랜덤 배정이 잘 됐는지 확인 가능


```python
X = ["gender", "age"]

mu = data.groupby("cross_sell_email")[X].mean()
var = data.groupby("cross_sell_email")[X].var()

norm_diff = ((mu - mu.loc["no_email"])/np.sqrt((var+var.loc["no_email"])/2))
```
<img width="276" alt="스크린샷 2024-09-11 오후 1 10 31" src="https://github.com/user-attachments/assets/ca6ca002-dd46-4d41-afc3-ab452074bb1a">

결과 해석 : 짧은 이메일을 받은 그룹은 성별 차이가 크고, 긴 이메일을 받은 그룹은 나이 차가 좀 크다
보완 사항 : 표본 수가 더 많았다면 아마 0.5로 수렴하지 않았을까....




# 2-2. 추정값이 통계적으로 유의한가?
예시를 통해 마케팅 메일의 전환효과를 분석해보았다. 그런데 과연 이 실험이 정말 통계적으로 유의할까? 우연은 아니었던걸까?

## 신뢰구간
교차 판매 이메일 사례에서 여러 번 실험하고 각각의 전환율을 계산해보면 정확히 같지는 않더라도 실제 전환율에 근접할 수 있다 -> 표본 수가 많아지면 중심극한정리에 의해 정규분포에 근사하기 때문에
  
<img width="438" alt="스크린샷 2024-09-11 오후 10 29 06" src="https://github.com/user-attachments/assets/9ba08694-16f6-4b19-8d99-d5fe8ab568ef">
  
실험의 평균값은 실제 이상적인 평균과 항상 일치한다고 볼 수는 없다. 그러나 표준오차를 사용해 진행하는 실험의 95%에서 실제 평균을 포함하는 구간을 만들 수 있다(신뢰구간)
**그룹간의 차이에 따른 분포가 신뢰구간이 겹친다고 해서 통계적으로 유의한 것은 아님!!** -> **신뢰구간이 겹치지 않았다면 통계적으로 유의한 차이가 있는것!** -> 신뢰구간은 추정값에 대해 불확실성을 나타내는 방법


## 가설검정
불확실성을 반영하는 또 다른 방법은 가설검정을 통해 결과를 제시하는 것 -> 두 독립 정규분포의 합이나 차이 역시 정규분포 -> 그 결과로 생성된 분포의 평균은 원래 두 분포 평균의 합이나 차이가 되고 분산은 항상 두 분산의 합으로 계산
  
<img width="376" alt="스크린샷 2024-09-11 오후 10 48 10" src="https://github.com/user-attachments/assets/ecef81ae-63ce-42b0-b278-f37c6b45225a">
  
**두 그룹의 예상 분포를 가지고 한 그룹에서 다른 그룹을 빼면 그 차이의 분포를 얻을 수 있음. 이 분포를 통해 평균 차이에 대한 95% 신뢰구간을 구하여 가설 검정 가능**

## 귀무가설
신뢰구간을 활용하면 귀무가설에 관한 질문에 대답을 할 수 있다. 그렇다면 귀무가설이란? -> 보통 아무 일도 일어나지 않는(관계가 없다) 상황을 귀무가설로 설정, 일어난다를 대립가설로 설정하여 분석. 각각 H0, H1
가설을 세운 후 귀무가설이 참이라면 이런 아무 일도 일어나지 않는 부분을 실제로 관측할 수 있을까? -> 그런데 위의 그래프에서 보면 둘의 차이는 0 이상이며 신뢰구간에도 포함되지 않음 -> 즉, 둘은 관계가 있다 -> 귀무가설 기각
**귀무 가설은 때로 특정 값으로 설정하는 경우도 존재. 해당 경우는 분포를 특정 값 만큼 평행이동 시킨 후 신뢰구간 확인**

## 검정통계량
신뢰구간 외에도 검정통계량을 사용하여 귀무가설을 기각하는 것이 가능. 검정통계량 값이 클수록 귀무가설을 기각하는 방향으로 설정. 대표적인 검정통계량은 t-통계량
  
<img width="169" alt="스크린샷 2024-09-11 오후 10 52 37" src="https://github.com/user-attachments/assets/5386d824-bc29-4cfe-a95c-28561277ca98">
  
여기서 H0은 귀무가설에서 정의한 값(위에서 특정한 값만큼 평행이동 시킨다는 개념 내포)

## p값
귀무가설이 참이라고 가정할 때 관측된 결과보다 더 극단적인 결과가 실제로 관측될 확률. 귀무가설이 참일 확률이 아니며 참인 경우에서 극단적인 측정값이 나올 확률을 의미
not P(H0|data), P(data|H0)
p 값의 장점은 신뢰구간을 정할 필요가 없다는 것. 

## 검정력
귀무가설을 올바르게 기각할 확률을 검정력이라고 부름. 귀무가설을 판단하기 위해서는 이를 정확하게 기각할만큼 충분히 큰 표본을 확보하는 것이 목표인데, 이때 검정력은 실험에 필요한 표본 크기를 파악할 때 뿐만아니라, 제대로 실행하지 않은 실험에서 문제를 발견할 떄도 유용하게 사용됨. a가 실제로 참인 귀무가설을 잘못 기각할 확률(1종 오류)인 반면, 검정력 (1-b)는 귀무가설이 거짓인 경우 이를 올바르게 기각할 확률.

<img width="303" alt="스크린샷 2024-09-11 오후 10 58 43" src="https://github.com/user-attachments/assets/63fe380b-7942-4eb1-9db1-efcf8165bebd">

검정력은 1-b. 여기서 b는 귀무가설이 실제로 거짓일 때 이를 기각하지 않을 확률. 검정력은 일반적으로 80% 잡기 때문에 실제로 거짓일 경우에도 기각하지 않을 확률이 20%. 80%의 검정력을 달성하려면 귀무가설이 거짓일 때 80% 확률로 귀무가설을 기각해야하는데 이는 95%신뢰구간의 하한값이 0보다 크며 이렇게 유의한 차이가 전체 실험의 80%에서 나타나야 한다는 것을 의미. 즉, 95% 신뢰구간의 하한이 0보다 높은 경우가 전체 실험의 80%에 달해야함.
80%를 만드는 정규분포의 표준편차는 0.84. 즉 차이가 0에서 1.96se+0.84se만큼 떨어져 있어야함. 여기서 1.96은 95% 신뢰구간을 확보하기 위한 값이며 0.84는 신뢰구간의 하한이 0을 초과하는 경우가 전체의 80%ㅇ에 해당하도록 하기 위한 값.

## 표본 크기 계산
검정력을 바라보는 또 다른 관점은 귀무가설이 거짓일 때 귀무가설과 관측된 추정값의 차이인 시그마를 감지할 수 있어야 한다는 것. 감지가능한 효과는 2.8SE였으며 이메일 변환 예시에서 본 것처럼 8% 차이를 감지하고자 하는 교차 판매 이메일 실험을 설계하고자 한다면, 적어도 8% = 2.8SE를 감지할 표본의 **크기**를 확보해야함. 
  
<img width="163" alt="스크린샷 2024-09-11 오후 11 03 46" src="https://github.com/user-attachments/assets/e0fc2aa7-f6b4-49a2-a048-f71e1e1bce8b">
<img width="421" alt="스크린샷 2024-09-11 오후 11 07 03" src="https://github.com/user-attachments/assets/371c1173-d230-4b02-9ddf-193b505c73b6">
  
이런 식을 통한다면 우리가 필요한 n값을 유추 가능!!! 해당 실험에서는 실험군의 표본이 103개 정도 필요해야한다는 것을 파악. -> 적절한 실험이었구나 확인 가능

















