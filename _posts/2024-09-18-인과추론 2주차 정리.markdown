---
layout: post
title:  "인과추론 2주차 정리"
date:   2024-09-18 13:13+09:00
categories: khuda causal inference study
---
# 1. 선형회귀와 인과추론

## 1-1. 선형회귀의 필요성
 만약 대출 금액이나 신용카드 한도가 채무 불이행률에 미치는 영향을 알아보려고 한다. 그렇다면 입력 : 대출 금액 & 신용한도 -> 출력 : 채무 불이행률
당연히 우리는 신용카드 한도를 늘리면 신용카드 대금을 미납할 확률(양의 상관관계)이 높을 것이라고 생각하겠지만 실제 은행 데이터를 살펴보면 신용 한도와 채무불이행률 사이에는 음의 상관관계가 존재
-> 은행과 대출 회사들이 자체 심사 모델에 따라 채무불이행 가능성이 낮다고 판단되는 고객에게 더 높은 신용한도를 설정하는 방식 (처치를 무작위가 아닌 배정함으로써 교란편향 발생)

**원래라면 무작위 배정(편향을 줄이는) 이후 평균값 비교 및 표준오차를 계산하여 신뢰구간을 구하는 번거로운 과정이 필요했으나 회귀분석으로 해석하면 모든 추론 통계량을 바로 얻을 수 있음**


## 1-2. 회귀 분석을 통한 보정
<img width="556" alt="스크린샷 2024-09-18 오후 1 21 02" src="https://github.com/user-attachments/assets/08344647-a4d2-4d12-ab18-8959cb65c31c">

  
이렇게 임금, 신용점수, 신용한도, 채무 불이행률 등의 데이터가 있는 상황

<img width="182" alt="스크린샷 2024-09-18 오후 1 22 11" src="https://github.com/user-attachments/assets/27014ee8-aa30-4dd6-816e-47b4dcff55ae">

이렇게 신용한도(line)에 따른 채무 불이행률을 선형회귀로 나타낼 수 있다 -> 해당 식의 의미는 추정된 기울기 베타1에 따라 신용한도가 1달러 증가할 때 채무불이행률이 얼마나 변할지에 대한 기댓값을 의미
  
<img width="562" alt="스크린샷 2024-09-18 오후 1 23 27" src="https://github.com/user-attachments/assets/5c905328-cce8-4000-8f2b-0daadafb9c50">
<img width="557" alt="스크린샷 2024-09-18 오후 1 24 38" src="https://github.com/user-attachments/assets/f9286d83-f53f-417a-9076-09c2431f7305">

하지만 실제로 보면 기울기가 음수값으로 음의 상관관계가 도출된 다는 것을 알 수 있다. 하지만 은행은 위험이 적은 고객에게 더 높은 한도를 주는 경향(무작위 처치 배정 위반)이 있기 때문에 교란이 발생하여 이러한 결과가 나타난 것으로 해석

<img width="458" alt="스크린샷 2024-09-18 오후 1 26 01" src="https://github.com/user-attachments/assets/2fcc28f5-8395-4465-a36c-2d3beb7eadaa">

해당 편향을 보정하려면 교란 요인들을 하나의 입력변수로 다중회귀분석을 하면 된다.
Then, why? -> 이 모델은 다른 모든 변수가 고정된 상태에서 신용한도를 조금 늘렸을 때 채무불이행률이 얼마나 변할지에 대한 기댓값을 출력. 즉, 처치와 결과 사이의 관계를 추정하는 동안 교란 요인을 고정하기 때문.

  
<결과>
  
<img width="548" alt="스크린샷 2024-09-18 오후 1 27 27" src="https://github.com/user-attachments/assets/c46389c0-7d76-4455-a2bc-7c046a01a036">
  
  

<br>
<br>
## 1-3. 프리슈-워-로벨(FWL) 정리
1. 편향 제거 단계 : 처치를 교란요인에 회귀하여 처치 잔차 T-T'를 구합니다
2. 잡음 제거 단계 : 결과를 교란요인에 회귀하여 결과 잔차 Y-Y'를 구합니다
3. 결과 모델 단계 : 결과 잔차 Y-Y'를 처치 잔차 T-T'에 대해 회귀하여 인과효과 추정값을 구합니다

  <br>
  말이 어려워보이는데 쉽게 말하면, 아까 같은 채무불이행률 예측 상황에서 대부분의 은행들은 위험이 적은(교란요인) 고객에게 더 높은 한도(처치)를 주는 경향이 있었다. 
 즉, 우선 해당 교란요인들을 독립변수로, 처치를 종속변수로 회귀하여 편향 제거 효과를 도출
 그 다음, 결과(채무불이행률) 또한 교란요인들을 독립변수로, 결과를 종속변수로 하여 잡음 제거 효과 도출
 마지막으로 각 단계에서 나온 편향 제거된 처치 효과로 잡음 제거된 결과를 회귀하여 인과효과 추정
  
 -> 근데 그냥 다중회귀분석 때린거랑 결과 똑같음... 그냥 다중회귀 한번에 때린게 더 편해보인다
  
  <br>
  <br>
 ## 1-4. 비선형 관계일때는?
 그럼 처치를 결과와 선형 관계로 변환하면 된다 -> 로그함수, 제곱근 함수 등 가능
   <br>
<처치 전>
  <br>
 <img width="500" alt="스크린샷 2024-09-18 오후 1 49 03" src="https://github.com/user-attachments/assets/15341ade-0a4f-4364-9f50-45afee354b6a">
  <br>
  <br>
<처치 후>
  <br>
<img width="497" alt="스크린샷 2024-09-18 오후 1 49 29" src="https://github.com/user-attachments/assets/de2dcfe3-7b3f-4cbc-8a4f-9a2f2219ae1d">
  <br>
  <br>
    
## 1-4. 더미변수를 활용한 회귀분석
 회귀분석과 직교화는 훌륭하지만, 모든 전제는 교란요인 이외의 모든 것들은 처치와 독립이어야한다. 이에 따라 교란요인을 통제했을 때 처치가 무작위로 배정된 것처럼 보이도록 하는 것인데, 이는 실제로 꽤 어려운일이다.
모델에 모든 교란요인이 포함되는지를 판단하기는 매우 어려우므로 가능하면 무작위 실험하는 편이 가장 좋다. 하지만 예를 들어 은행에서 신용 한도를 무작위로 배정한다면, 큰 문제가 발생할 수 있다.
**-> 조건부 무작위 실험 또는 계층화가 필요**
  
  
  모든 고객에게 동일한 확률 븐포에서 완전히 무작위로 신용한도를 설정하는 실험을 설계하는 대신, 고객 특성에 따라 서로 다른 분포에서 표본을 뽑아 여러 국소 실험을 만든다.
 예를 들어 신용 점수가 고객 위험도의 대리 변수임을 알고 있으므로 이 변수를 사용하여 위험도에 따른 고객 그룹을 생성할 수 있다. 그리고 신용 점수가 낮은 고위험 그룹은 평균이 낮은 분포에서 신횽 한도를 추출하여 무작위로 배정하고 신용점수가 높은 저위험 고객은 평균이 높은 분포에서 추출하여 신용 한도를 무작위로 배정
   <br>
 <img width="553" alt="스크린샷 2024-09-18 오후 1 56 26" src="https://github.com/user-attachments/assets/58257df0-ff1f-472b-b488-f57411d81903">
  <br>
  <br>
 -> 조건부 무작위 실험이 완전 무작위 실험보다 낫다는 의미는 아님. 조건부 무작위 실험은 비용이 더 저렴하지만 복잡하며 어떤 이유로든 조건부 무작위 실험을 선택한다면 가능한 한 완전 무작위 실험에 가깝게 설계해야한다.
 <br>
 * 그룹 수가 적을수록 조건부 무작위 실험을 진행하기가 더 쉬워진다. 처치 분포가 서로 다른 여러 그룹을 결합하면 복잡해지므로 적은 수의 그룹을 유지하는 편이 좋다
 * 그룹 간 처치 분포가 많이 중첩될수록 분석이 용이해진다. 이는 양수성 가정과 관련있있다. 이 사례에서 고위험 그룹이 높은 신용 한도를 받을 확률이 0인경우, 고위험 그룹이 높은 신용한도를 받게된다면 어떤일이 발생할 지 알기 위해 위험한 외삽에 의존해야한다
   <br>
 이 두가지 경험적 규칙을 최대한 적용하면 완전한 무작위 실험으로 돌아가게 되는데 이는 두가지 규칙 모두에 트레이드오프가 존재. 즉, 그룹 수가 저곡 겹치는 부분이 많을수록 실험 결과 해석이 더 쉬워지지만 더 큰 비용이 발생.
  <br>
  <br>
 ### 더미변수
 조건부 무작위 실험의 장점은 설정한 범주형 변수에 따라 신용 한도가 무작위로 배정되었음을 알기 때문에, 조건부 독립 가정에 훨씬 더 설득력이 생긴다. 하지만 실험군에 대한 결과만으로 단순 회귀분석을 하면 편향된 추정값을 얻게되는 단점이 있다.
 이를 보정하려면 모델에 처치가 무작이로 배정된 그룹 정보를 포함해야한다. **왜냐하면 그룹에 따라 신용 한도를 다르게 처치했기 때문.**
   <br>
 <img width="572" alt="스크린샷 2024-09-18 오후 2 02 23" src="https://github.com/user-attachments/assets/ecc2567c-1c95-48e6-89bc-21990cd4c69f">
  <br>
  <br>
  -> 이렇게 더미변수(가변수)를 생성, 어떤 그룹에 속해있는 지를 1로 나타내는 것. **그룹 정보를 더미변수로 표현한다면 이를 포함하여 다중회귀 돌렸을때 신용 한도의 기울기는 변수로 표현된 다른 모든 특성들이 고정되었을 때 종속변수에 영향을 미치는 정도로 나타나기 때문에 그룹간 다르게 처치를 했던 것이 무작위 실험 처럼 보이는 것!!!!**
  <br>
   <br>
<img width="557" alt="스크린샷 2024-09-18 오후 2 05 10" src="https://github.com/user-attachments/assets/6881fe00-5842-4d67-9d6e-e951d723de1e">
  <br>
  <br>
### 포화회귀모델
 이진 처치에 대한 회귀분석은 실험군과 대조군의 평균을 비교하는 것과 같다. 더미변수는 이진값이므로 같은 논리가 여기에도 적용. 즉, 포화모델은 회귀분석에서 가능한 모든 설명변수와 그 상호작용을 포함하는 모델을 의미.
 이 모델은 주어진 데이터에 대해 모든 변수와 상호작용을 포함하므로 과적합 위험이 있고 일반화 능력이 떨어질 수 있으나 특정 그룹의 인과효괄ㄹ 파악하는 데 유용하게 쓰임
  <br>
  <br>
## 정리
 기본적으로, 모델에 더 많은 교란 요인을 포함할수록 인과 추정값의 편향은 줄어든다. 하지만 결과 예측력은 약하지만 처치 예측력은 강한 변수를 포함하면 편향이 감소하는 대신 분산이 증가한다는 치명적인 대가가 뒤따른다.
 즉 분산을 줄이기 위해 약간의 편향 증가를 감수해야할 수 있으며 모든 교란요인이 동일한 영향을 주는 것이 아님을 명심해야한다. 물론 모든 교란 요인은 처이와 결과에 영향을 끼친다는 공통점이 있지만 처치를 잘 설명하고 결과를 거의 설명하지 않는다면 보정 대상에서 배제해야한다. 
  인과추론에서 처치를 설명하는데 교란 요인의 영향이 어느정도 약해야 해당 변수를 제거할 수 있는지에 대한 기준은 아직 명확히 정립되지 않았다. 이러한 편향 - 분산 트레이드오프가 존재한다는 사실을 알자.
  <br>
  <br>
<br>
# 2. 성향점수
  앞 장에서는 선형회귀분석을 사용하여 교란 요인을 보정하는 방법을 배웠다. 더불어 편향 보정에 매우 유용한 방법인 직교화를 활용한 편향 제거라는 개념을 소개했다. 이번 장에서는 또다른 편향 제거 방법 중 하나인 성향점수 가중치를 배울 것이다. 이 방법은 직교화처럼 잔차를 생성하는 대신, 처치 배정 메커니즘을 모델링하고 모델 예측을 사용하여 데이터를 재조정한다.
이번 장에서 다룰 내용은 이진이나 이산형 처치가 있을때 특히 적합하다. 하지만 연속형일때도 성향점수 가중치를 사용할 수 있는 확장된 방법도 소개한다.
  <br>
<br>
## 2.1 관리자 교육의 효과
  IT 회사에서는 유능한 개인 기여자들이 관리직 경로로 전환하는 것이 일반적이다. 하지만 관리직은 IC로서의 재능과는 다른 기술이 필요할 때가 많아서 이러한 전환은 쉽지 않다. 이는 새로운 관리자뿐만 아니라 그들이 관리하는 팀원들에게도 큰 부담을 줄 수 있다.

  한 대형 다국적 기업이 새로운 관리자들을 대상으로 교육 프로그램에 투자해서 이 전환의 고통을 덜어주기로 했다. 또한 회사는 교육의 효과를 측정하려고 관리자들을 **무작위로** 프로그램에 참여시키려고 했다. 프로그램에 등록된 관리자의 직원들과 등록되지 않은 관리자의 직원들에 대한 참여도를 비교하려는 목적이었다. 무작위 배정을 활용한 간단한 비교로, 교육의 평균 처치효과를 알 수 있었다.

  하지만 상황은 그렇게 간단하지 않았다. 교육 프로그램에 배정된 일부 관리자는 참석하지 않았으며, 참석 대상이 아닌 관리자 중에서도 교육을 받은 이들이 있었다. 그 결과, 계획한 무작위 실험 연구가 관측연구와 매우 유사해졌다.
  이제 이 데이터를 다루는 분석가는 교란 요인을 보정하여 실험군과 대조군을 비교할 수 있도록 해야한다. 회사 관리자에 관한 데이터와 그들을 설명하는 몇가지 특성이 있다고 하자.
<br>
<img width="585" alt="스크린샷 2024-09-18 오후 2 35 54" src="https://github.com/user-attachments/assets/5d9a2fc6-b2a4-4831-bcf1-dff43701aaae">
<br>
